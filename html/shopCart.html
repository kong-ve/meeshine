<!DOCTYPE html>
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>购物车</title>
    <link rel="stylesheet" type="text/css" href="../css/api.css" />
    <link rel="stylesheet" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/aui-list-swipe.css" />
    <link rel="stylesheet" type="text/css" href="../feature/fonts/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="../css/shoppingCart.css"/>
</head>
<style media="screen">
  body{
    overflow-x: hidden;
  }
  .title-card img{
    width: 35px;
    height: 30px;
    float: left;
    border-radius: 50%
  }
  .aui-card-list-content .aui-list-view-cell:last-child:after {
    	border-bottom: 0;
  }
  #main{
    height: 100%;
  }
  #empty_cart{
    display: none;
    position: absolute;
    top: 40%;
    left: 25%;
    height: 50%;
  }
  #empty_cart p:first-child{
    color: #aeaeae;
    text-align: center;
    width: 100%;
  }

</style>
<body>
    <header class="aui-bar aui-bar-nav" id="header">
        <div class="aui-title">购物车</div>
        <div class="aui-pull-right aui-btn">
            <span class="aui-iconfont aui-icon-search"></span>
        </div>
    </header>
    <section id="main">
       <!-- <div class="aui-content aui-card-list">
        <div class="aui-card-list-header">
            <div class="title-card">
              <input id="heder" class="aui-pull-left aui-radio" type="checkbox" name="demo" data-check="demo1" onclick="product_header(this)">
              <img class="aui-img-round aui-padded-l-5" src="../image/suipai/bg.jpg"/>
              <span class="aui-padded-l-5 aui-padded-t-5 aui-font-size-14">店铺名</span>
            </div>
        </div>
        <div class="aui-card-list-content">
          <ul class="aui-list-view">
              <li class="aui-list-view-cell aui-img aui-counter-list">
                  <div class="aui-swipe-handle">
                    <input class="aui-pull-left aui-radio" type="checkbox" name="demo"data-check="demo1">
                  <img class="aui-img-object aui-pull-left" src="../image/demo4.png">
                  <div class="aui-img-body">
                      计数列表
                      <div class="aui-counter-box">
                          <div class="aui-pull-left aui-text-danger">¥ 88元</div>
                          <div class="aui-counter aui-danger aui-pull-right">
                              <div class="aui-counter-minus aui-disabled"></div>
                              <input class="aui-counter-input" type="text" value="1">
                              <div class="aui-counter-plus"></div>
                          </div>
                      </div>
                  </div>
                </div>
                  <div class="aui-swipe-right-btn aui-bg-danger">删除</div>
              </li>
              <li class="aui-list-view-cell aui-img aui-counter-list">
                <div class="aui-swipe-handle">
                  <input class="aui-pull-left aui-radio aui-radio-warning" type="checkbox" name="demo"data-check="demo1" checked>
                  <img class="aui-img-object aui-pull-left" src="../image/demo5.png">
                  <div class="aui-img-body">
                      计数列表
                      <div class="aui-counter-box">
                          <div class="aui-pull-left aui-text-danger">¥ 88元</div>
                          <div class="aui-counter aui-warning aui-pull-right">
                              <div class="aui-counter-minus aui-disabled"></div>
                              <input class="aui-counter-input" type="text" value="1">
                              <div class="aui-counter-plus"></div>
                          </div>
                      </div>
                  </div>
                </div>
                <div class="aui-swipe-right-btn aui-bg-danger">删除</div>
              </li>
              <li class="aui-list-view-cell aui-img aui-counter-list">
                <div class="aui-swipe-handle">
                  <input class="aui-pull-left aui-radio" type="checkbox" name="demo"data-check="demo1">
                  <img class="aui-img-object aui-pull-left" src="../image/demo2.png">
                  <div class="aui-img-body">
                      计数列表
                      <div class="aui-counter-box">
                          <div class="aui-pull-left aui-text-danger">¥ 88元</div>
                          <div class="aui-counter aui-info aui-pull-right">
                              <div class="aui-counter-minus aui-disabled"></div>
                              <input class="aui-counter-input" type="text" value="1">
                              <div class="aui-counter-plus"></div>
                          </div>
                      </div>
                  </div>
                </div>
                <div class="aui-swipe-right-btn aui-bg-danger">删除</div>
              </li>
          </ul>
        </div>
      </div> -->
      <div id="empty_cart">
        <p>Your Cart is empty</p><br/>
        <div class="aui-btn aui-btn-block aui-btn-outlined" onclick="closeFrame()"tapmode>Continue shopping</div>
      </div>
  </section>
    <footer class="aui-bar aui-bar-tab" id="footer">
      <div class="aui-bar-tab-item" style="width:70%;">
        <div class="aui-bar-tab-item sellAll" tapmode>
            <label><input class="aui-radio" type="checkbox" name="checkbox" onclick="SelectList_all(this)"></label>
        </div>
        <div class="aui-bar-tab-item selectNumber" tapmode >
            <div class="aui-bar-tab-label aui-text-defalut">全选</div>
        </div>
        <div class="aui-bar-tab-item priceSum" tapmode>
            <div class="aui-bar-tab-label aui-text-defalut">$<span id="sum">0</span></div>
        </div>
      </div>
        <div class="aui-bar-tab-item aui-bg-danger aui-text-white" tapmode style="width: auto;">立即购买</div>
    </footer>
</body>

</html>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/aui-list-swipe.js"></script>
<script>
var swipe;
    apiready = function() {
        api.parseTapmode();
        var header  = $api.byId('header');
        $api.fixStatusBar(header);
        $api.css(document.body,'height:'+api.frameHeight+'px');
        getList();
         swipe = new ListSwipe();
    }
    function closeFrame(){
      api.closeFrame({
      });

    }
    function SelectList_all(d){
      var a = $api.domAll('input[type="checkbox"]');
        for(var i = 0;i<a.length;i++){
          a[i].checked = d.checked;
      }
    }
    function getList() {
      api.ajax({
          url: 'http://mv.anhy.net/index.php?dispatch=checkout.cart&appajax=1&is_ajax=1',
          method: 'get',
          headers:{
            Cookie:localStorage.getItem('token'),
            // 'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.157 Mobile Safari/537.36'
          }
      },function(ret, err){

          if (ret) {
              console.warn( JSON.stringify( ret.result.data.cart_products.value.length) );
            if(ret.result.data.cart_products.value.length <1){
              $api.byId('empty_cart').style.display = 'block';
              $api.byId('footer').style.display = 'none';
              return;
            }
              console.warn( JSON.stringify( ret.result.data) );
              var main = $api.byId('main');
              $api.text($api.byId('sum'),ret.result.data.cart.value.total);
              var car_product = ret.result.data.cart_products.value;
              var aui_card_list = document.createElement('div');
              aui_card_list.className = 'aui-content aui-card-list';
              var aui_card_list_header = document.createElement('div');
              aui_card_list_header.className='aui-card-list-header';
              var title_card = document.createElement('div');
              title_card.className = 'title-card';
              var heder = document.createElement('input');
              heder.className = 'aui-pull-left aui-radio';
              heder.type ='checkbox';
              heder.id= 'heder';
              heder.name = 'demo';
              heder.setAttribute('data-check','demo1');
                heder.setAttribute('onclick','product_header(this)');
              var aui_img_round = document.createElement('img');
              aui_img_round.className = 'aui-img-round aui-padded-l-5';
              aui_img_round.src = '../image/suipai/bg.jpg';
              var span = document.createElement('span');
              span.className = 'aui-padded-l-5 aui-padded-t-5 aui-font-size-14';
              span.innerText = '店铺名';
                var aui_card_list_content = document.createElement('div');
                aui_card_list_content.className="aui-card-list-content";
                  var aui_list_view = document.createElement('ul');
                  aui_list_view.className = 'aui-list-view';

              var li_list = '';
            for(var keys in car_product){
              var key = car_product[keys];
                var calss = 'aui-counter-minus aui-disabled';
                if(key.amount >1){
                  calss = 'aui-counter-minus';
                }
                var li = document.createElement('li');
                li.className = 'aui-list-view-cell aui-img aui-counter-list';
                li.id = keys;
                var aui_swipe_handle = document.createElement('div');
                aui_swipe_handle.className = 'aui-swipe-handle';
                  var input = document.createElement('input');
                  input.className='aui-pull-left aui-radio';
                  input.setAttribute("data-check","demo1");
                  input.name='demo';
                  input.type="checkbox";
                  var img_obj = document.createElement('img');
                  img_obj.className ='aui-img-object aui-pull-left';
                  img_obj.src = key.main_pair.detailed.image_path;
                  var aui_img_body = document.createElement('div');
                  aui_img_body.className='aui-img-body';
                  aui_img_body.id = key.product_id;
                  aui_img_body.innerText =   key.product+"   category:"+key.main_category;
                  var aui_counter_box = document.createElement('div');
                  aui_counter_box.className = 'aui-counter-box';
                  var price = document.createElement('div');
                  price.className = 'aui-pull-left aui-text-danger';
                  price.innerText = '$ '+key.price;
                  var aui_pull_right = document.createElement('div');
                  aui_pull_right.className = 'aui-counter aui-danger aui-pull-right';
                  var minus = document.createElement('div');
                  minus.className = calss;
                  var aui_counter_input = document.createElement('input');
                  aui_counter_input.className = 'aui-counter-input';
                  aui_counter_input.type = 'text';
                  aui_counter_input.value = key.amount;
                  // console.log(key.amount)
                  var plus = document.createElement('div');
                  plus.className = 'aui-counter-plus';
                  var del = document.createElement('div');
                  del.className = 'aui-swipe-right-btn aui-bg-danger tapmode';
                  del.innerText='删除';
                  del.setAttribute('data-id',keys);

                  aui_pull_right.appendChild(minus)
                    aui_pull_right.appendChild(aui_counter_input)
                      aui_pull_right.appendChild(plus)
                  aui_counter_box.appendChild(price);
                  aui_counter_box.appendChild(aui_pull_right);
                  aui_img_body.appendChild(aui_counter_box);
                  aui_swipe_handle.appendChild(input);
                  aui_swipe_handle.appendChild(img_obj);
                  aui_swipe_handle.appendChild(aui_img_body);
                  li.appendChild(aui_swipe_handle);
                  li.appendChild(del);
                  aui_list_view.appendChild(li)
              }
              aui_card_list_content.appendChild(aui_list_view);
              title_card.appendChild(heder);
              title_card.appendChild(aui_img_round);
              title_card.appendChild(span);
              aui_card_list_header.appendChild(title_card);
              aui_card_list.appendChild(aui_card_list_header);
              aui_card_list.appendChild(aui_card_list_content);
              // $api.append(main, html);
              main.appendChild(aui_card_list);
              var del_btn = $api.domAll('.aui-swipe-right-btn');
              for(var q = 0;q<del_btn.length;q++){
                $api.addEvt(del_btn[q], 'touchstart',delCart,true);
              }
              var a =$api.domAll('.aui-counter-plus');
              for(var i = 0;i<a.length;i++){
                $api.addEvt(a[i], 'touchstart',plusclick);
              }
                  var b = $api.domAll('.aui-counter-minus');
                  for(var k = 0;k<b.length;k++){
                    if(!$api.hasCls(b[k],'aui-disabled'))
                    $api.addEvt(b[k], 'touchstart',minusclick);
                  }


          } else {
              alert( JSON.stringify( err ) );
          }
      });

    }
    function product_header(d) {
        console.log('selected');
      var a = $api.domAll('input[data-check="'+$api.attr(d,'data-check')+'"]');
      console.log(a.length)
        for(var i = 0;i<a.length;i++){
          a[i].checked = d.checked;
      }
    }
function delCart(){
var d = this;
  var id = d.getAttribute('data-id');
    console.warn(JSON.stringify(id))
  console.log('del');
  var url = 'http://mv.anhy.net/index.php?appajax=1&is_ajax=1&dispatch=checkout.delete&cart_id='+id+'&redirect_mode=cart';
console.log(url);
  api.ajax({
      url: url,
      method: 'get',
      headers:{
        Cookie:localStorage.getItem('token'),
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.157 Mobile Safari/537.36'
      }
  },function(ret, err){
      if (ret) {
          console.warn( JSON.stringify( ret ) );
          var q = $api.closest($api.byId(id),'.aui-card-list');
          var q_c_list = $api.domAll(q, '.aui-counter-list');
          if(q_c_list.length > 1){
              $api.remove($api.byId(id))
          }else{
              $api.remove(q);
              if($api.domAll('.aui-card-list').length >1){
              $api.byId('empty_cart').style.display = 'block';
              $api.byId('footer').style.display = 'none';
            }
          }

      } else {
          alert( JSON.stringify( err ) );
      }
  });

}
function minusclick() {
  var par = this.parentNode;
  var vl = $api.val($api.dom(par,'.aui-counter-input'));
  if(vl == 2){
    $api.addCls(this, 'aui-disabled');
      $api.rmEvt($api.dom(par,'.aui-counter-minus'), 'touchstart',minusclick)
  }
  $api.val($api.dom(par,'.aui-counter-input'),Number(vl)-1);
  var cart_id = $api.attr($api.closest(this,'li'),'id');
  ChangeNum(cart_id,Number(vl)+1,$api.dom(par,'.aui-counter-input'));
}
function plusclick() {
  var par = this.parentNode;
  var vl = $api.val($api.dom(par,'.aui-counter-input'));
  if(vl == 1){
    $api.removeCls($api.dom(par,'.aui-counter-minus'), 'aui-disabled');
    $api.addEvt($api.dom(par,'.aui-counter-minus'), 'touchstart',minusclick)
  }
  $api.val($api.dom(par,'.aui-counter-input'),Number(vl)+1);
  var cart_id = $api.attr($api.closest(this,'li'),'id');
  ChangeNum(cart_id,Number(vl)+1,$api.dom(par,'.aui-counter-input'));
}
function ChangeNum(id,val,domm){
  var list = {
    redirect_mode:'cart',
     result_ids: 'cart*,checkout*' ,
    cart_products:{},
    full_render: true ,
    security_hash: '',
    is_ajax: 1
  }
  list.cart_products[id] ={}
  list.cart_products[id]['product_id']= $api.attr($api.closest(domm,'.aui-img-body'),'id');
  list.cart_products[id]['amount']= val;
  api.ajax({
      url: 'http://mv.anhy.net/index.php?dispatch=checkout.update&appajax=1&is_ajax=1',
      method: 'post',
      headers:{
        'User-Agent': 'Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.157 Mobile Safari/537.36'
      },
      data: {
         values: list,
      }
  },function(ret, err){
      if (ret) {
          alert( JSON.stringify( ret ) );
      } else {
          alert( JSON.stringify( err ) );
      }
  });

}
</script>
